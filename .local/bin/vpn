#!/bin/sh
#
# Connecting and disconnecting vpn
# l2tp / ipsec (strongswan and xl2tpd)
# https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/docs/clients.md#configure-linux-vpn-clients-using-the-command-line

CONTROL_PIPE=/var/run/xl2tpd/l2tp-control
VPN_IP=31.28.8.152
LOCAL_IP=$(ip route | head -1 | cut -d" " -f 3)

if [ $# -eq 0 ]; then
    wget -qO- http://ipv4.icanhazip.com
elif [ $1 = "on" ]; then

    sudo mkdir -p /var/run/xl2tpd
    sudo touch $CONTROL_PIPE

    sudo systemctl restart strongswan
    sudo ipsec restart
    sudo systemctl restart xl2tpd

    sudo ipsec up myvpn
    echo "c myvpn" | sudo tee $CONTROL_PIPE
    sudo route add $VPN_IP gw $LOCAL_IP
    sleep 5
    sudo route add default dev ppp0

elif [ $1 = "off" ]; then
    sudo route del default dev ppp0
    sudo route del $VPN_IP gw $LOCAL_IP
    echo "d myvpn" | sudo tee $CONTROL_PIPE
    sudo ipsec down myvpn

    sudo systemctl stop strongswan
    sudo systemctl stop xl2tpd
    sudo ipsec stop
else
    echo "possible args: on / off"
fi
